#
# $Id$
# $Source$
# Copyright 2011 Brad Lanam, Walnut Creek, California USA
#
#
option-file ../dioptions.dat

loadunit d-main

output  config.d

standard

csizes

# di.d: for version
chdr    version.h

# NLS support:
# libintl.h has dcls for gettext(), et. al.
chdr    libintl.h
# locale.h has LC_ALL
chdr    locale.h
# unistd.h has geteuid, et. al.
chdr    unistd.h

# diskpart.d:
# Linux:
#   _PATH_MOUNTED MNTTYPE_IGNORE
chdr    mntent.h
# Linux:
#   for struct statvfs, statvfs()
csys    statvfs.h
# FreeBSD:
#   for getfsstat(); MNT_NOWAIT; struct statfs
csys    mount.h

# diquota.d:
# Linux:
#   XGETQUOTA
chdr    linux/dqblk_xfs.h
# Solaris:
csys    fs/ufs_quota.h
# Linux:
#   quotas: QCMD, SUBCMD*, struct dqblk, USRQUOTA, GRPQUOTA
csys    quota.h
#   quotas: uid_t, gid_t
csys    types.h
# FreeBSD:
#   quotas: QCMD, SUBCMD*, struct dqblk, USRQUOTA, GRPQUOTA
chdr    ufs/ufs/quota.h

# NFS quotas
chdr    rpc/types.h
# FreeBSD has broken rpc headers
chdr    rpc/auth.h rpc/types.h
chdr    rpc/clnt.h rpc/types.h rpc/auth.h
chdr    rpc/rpc.h
chdr    rpcsvc/rquota.h

### Other C library routines
clib    exit
cdcl    exit

### For NLS support

clib    bindtextdomain -lintl, -lintl -liconv
clib    gettext -lintl, -lintl -liconv
clib    setlocale
clib    textdomain -lintl, -lintl -liconv
cdefine hex LC_ALL
cdcl    bindtextdomain
cdcl    gettext
cdcl    setlocale
cdcl    textdomain
command msgfmt
command gmsgfmt

### diskpart.d:

# FreeBSD:
#   getfsstat
clib    getfsstat
cdcl    args noconst getfsstat
# Linux:
#   get/set/endmntent
clib    endmntent
cdcl    endmntent
#   some unixware needs -lgen
clib    getmntent -lgen
cdcl    getmntent
clib    setmntent
cdcl    args noconst setmntent
# Linux: statvfs
clib    statvfs
cdcl    statvfs
# Linux: from statvfs.h
cstruct statvfs
cmember statvfs f_basetype
# Linux: from mntent.h
cdefine string _PATH_MOUNTED
cdefine string _PATH_MNTTAB
cdefine string MOUNTED
cdefine string MNTTAB
# Linux: from mntent.h
cdefine string MNTTYPE_IGNORE
# Linux: from mntent.h
cstruct mntent
# Linux: from statvfs.h
ctype int __fsblkcnt_t
ctype int __fsfilcnt_t
# Linux: 64-bit: from statvfs.h
ctype int __fsblkcnt64_t
ctype int __fsfilcnt64_t
# FreeBSD: struct statfs from mount.h
ctype int uint32_t
ctype int uint64_t
ctype int int64_t
cstruct fsid
cstruct statfs
cdefine int MNT_NOWAIT
# FreeBSD: for struct statvfs from statvfs.h
ctype int fsblkcnt_t
ctype int fsfilcnt_t

### diquota.d

# uid/gid; geteuid, getegid
ctype int gid_t
ctype int __gid_t
ctype int uid_t
ctype int __uid_t
clib    getegid
clib    geteuid
cdcl    getegid
cdcl    geteuid

# from sys/quota.h
cdefine hex SUBCMDSHIFT
cdefine hex SUBCMDMASK
if sysquota _sys_quota
 cmacro  QCMD sys/quota.h int int int
endif
if ufsufsquota _hdr_ufs_ufs_quota
 cmacro  QCMD ufs/ufs/quota.h int int int
endif
cdefine hex Q_GETQUOTA
cdefine hex Q_XGETQUOTA
cdefine hex USRQUOTA
cdefine hex GRPQUOTA

# from rpcsvc/rquota.h
cdefine int RQUOTAPROG
cdefine int RQUOTAVERS
cdefine int RQUOTAPROC_GETQUOTA

# from sys/quota.h
#   linux
clib    quotactl
cdcl    args noconst quotactl
cstruct dqblk
cmember  dqblk dqb_curspace
cmember  dqblk dqb_curblocks
cmember  dqblk dqb_fhardlimit
cmember  dqblk dqb_fsoftlimit
cmember  dqblk dqb_curfiles

# from linux/dqblk_xfs.h
#   linux
ctype int __s8
ctype int __s16
ctype int __s32
ctype int __u16
ctype int __u32
ctype int __u64

# Linux:
cdefine hex BLOCK_SIZE
# Linux: xfs quotas
cstruct fs_disk_quota

# Tru64, et. al.
cdefine hex DEV_BSIZE
# FreeBSD:
cdefine int __FreeBSD__
# AIX:
cdefine hex DQBSIZE
cdefine int _AIX

# from rpcsvc/rquota.h
#   linux
cdefine int TRUE
cdefine int FALSE
ctype int u_int64_t
ctype int u_int32_t
ctypedef __caddr_t
ctypedef caddr_t

# from rpc/auth.h
clib authunix_create_default
cdcl authunix_create_default
cmacro auth_destroy rpc/auth.h void 'AUTH *'
clib auth_destroy
cdcl auth_destroy

# from rpc/clnt.h
cmacro clnt_call rpc/clnt.h clnt_stat 'CLIENT *' u_long xdrproc_t caddr_t xdrproc_t caddr_t 'struct timeval'
cmacro clnt_destroy rpc/clnt.h void 'CLIENT *'
clib    clnt_create
cdcl    clnt_create

# NFS quotas
clib    xdr_quota_get
cdcl    xdr_quota_get
clib    xdr_quota_rslt
cdcl    xdr_quota_rslt
clib    xdr_string
cdcl    xdr_string
clib    xdr_int
cdcl    xdr_int
clib    xdr_u_int
cdcl    xdr_u_int
clib    xdr_bool
cdcl    xdr_bool

cdefine int RQ_PATHLEN

# from rpcsvc/rquota.h
ctype int bool_t
ctype int enum_t
ctype int u_int
ctype int u_long
ctype int int32_t
cstruct rquota
ctypedef rquota
cmemberxdr rquota rq_bhardlimit
cmemberxdr rquota rq_bsoftlimit
cmemberxdr rquota rq_curblocks
cmemberxdr rquota rq_fhardlimit
cmemberxdr rquota rq_fsoftlimit
cmemberxdr rquota rq_curfiles
cenum   gqr_status
ctypedef gqr_status
cstruct getquota_rslt
cmember  getquota_rslt gqr_status
cmember  getquota_rslt gqr_rquota

cenum xdr_op
cenum clnt_stat
cenum auth_stat
ctypedef xdrproc_t
# Linux:
ctype int  __time_t
ctype int  __suseconds_t
# FreeBSD:
ctype int time_t
ctype int suseconds_t
ctype int rpcproc_t
ctype int rpcprog_t
ctype int rpcvers_t
#
cstruct timeval
cstruct rpc_err
cstruct getquota_args
cmembertype getquota_args gqa_uid
cmemberxdr getquota_args gqa_uid
cstruct opaque_auth
cunion des_block
cstruct AUTH
ctypedef AUTH
cstruct CLIENT
ctypedef CLIENT
cstruct XDR
ctypedef XDR

### di.d
cdefine string DI_VERSION

### options
# see dioptions.dat to change these
option  DI_DEFAULT_FORMAT smbuvpT
option  DI_DEFAULT_DISP_SIZE H

ifnotoption NLS
  set _lib_bindtextdomain 0
  set _lib_gettext 0
  set _lib_setlocale 0
  set _lib_textdomain 0
  set _hdr_libintl 0
  set _hdr_locale 0
  set _command_msgfmt 0
  set _command_gmsgfmt 0
endif

if hasnls _clib_bindtextdomain && _clib_gettext && _clib_setlocale && \
    _clib_textdomain && _hdr_libintl && _hdr_locale && \
    ( _command_msgfmt || _command_gmsgfmt )
  setint _enable_nls 1
else
  set _clib_bindtextdomain 0
  set _clib_gettext 0
  set _clib_setlocale 0
  set _clib_textdomain 0
  set _hdr_libintl 0
  set _hdr_locale 0
  set _command_msgfmt 0
  set _command_gmsgfmt 0
  setint _enable_nls 0
endif

if stdquotas _hdr_linux_quota || _hdr_ufs_quota || _hdr_ufs_ufs_quota || \
    _sys_fs_ufs_quota || _sys_quota || _clib_quotactl
  setint _has_std_quotas 1
else
  setint _has_std_quotas 0
endif

if stdnfsquotas _hdr_rpc_rpc && _hdr_rpcsvc_rquota && _clib_xdr_int && \
    _cmemberxdr_rquota_rq_bhardlimit && _cmemberxdr_getquota_args_gqa_uid
  setint _has_std_nfs_quotas 1
else
  setint _has_std_nfs_quotas 0
endif

include

static if (_ctype_uid_t > 0) {
  alias C_TYP_uid_t   Uid_t;
} else {
  alias int     Uid_t;
}
static if (_ctype_gid_t > 0) {
  alias C_TYP_gid_t   Gid_t;
} else {
  alias int     Gid_t;
}

enum string DI_PROG = "di";
enum string DI_PREFIX = "/home/bll/DI/di/C/test_di";

// needed for getmntent()
import core.stdc.stdio;  // for FILE

static if (_enable_nls) {
  import std.string;
  import std.conv : to;
  auto DI_GT (string txt) { return (to!string(gettext(toStringz(txt)))); }
} else {
  auto DI_GT (string txt) { return (txt); }
}

endinclude
